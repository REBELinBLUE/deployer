Lang.addMessages({"en":{"app.yes":"Yes","app.no":"No","dashboard.pending":":count pending deployment|:count pending deployments","dashboard.running":":count running deployment|:count running deployments","dashboard.deployment_number":"Deployment #:id","deployments.completed":"Completed","deployments.completed_with_errors":"Completed with errors","deployments.pending":"Pending","deployments.deploying":"Deploying","deployments.running":"Running","deployments.cancelled":"Cancelled","deployments.failed":"Failed","variables.create":"Add a new variable","variables.edit":"Edit the variable","projects.create":"Add a new project","projects.edit":"Edit a project","projects.finished":"Finished","projects.pending":"Pending","projects.deploying":"Deploying","projects.failed":"Failed","projects.not_deployed":"Not Deployed","checkUrls.create":"Add a new URL","checkUrls.edit":"Edit the URL","checkUrls.successful":"Online","checkUrls.failed":"Offline","checkUrls.untested":"Unknown","checkUrls.length":"Minutes","checkUrls.log_title":"Failure Log","commands.create":"Add a new command","commands.edit":"Edit a command","groups.create":"Add a new group","groups.edit":"Edit a group","users.create":"Add a new user","users.edit":"Edit a user","templates.create":"Add a new template","templates.edit":"Edit the template","sharedFiles.create":"Add a new file or folder","sharedFiles.edit":"Edit the file or folder","configFiles.create":"Add a new file","configFiles.edit":"Edit the file","channels.create":"Add a new notification","channels.edit":"Edit the notification","channels.custom":"Custom","channels.slack":"Slack","channels.hipchat":"Hipchat","channels.twilio":"Twilio","channels.mail":"E-mail","channels.create_slack":"Add a new Slack notification","channels.create_hipchat":"Add a new Hipchat notification","channels.create_twilio":"Add a new Twilio notification","channels.create_mail":"Add a new e-mail notification","channels.create_custom":"Add a new custom notification","channels.edit_slack":"Edit the Slack notification","channels.edit_hipchat":"Edit the Hipchat notification","channels.edit_twilio":"Edit the Twilio notification","channels.edit_mail":"Edit the e-mail notification","channels.edit_custom":"Edit the custom notification","servers.create":"Add a new server","servers.edit":"Edit the server","servers.successful":"Successful","servers.testing":"Testing","servers.failed":"Failed","servers.untested":"Untested","servers.log_title":"Test Log","heartbeats.create":"Add a new heartbeat","heartbeats.edit":"Edit the heartbeat","heartbeats.ok":"Healthy","heartbeats.untested":"Waiting for Heartbeat","heartbeats.missing":"Missing in Action","heartbeats.interval_10":"10 minutes","heartbeats.interval_30":"30 minutes","heartbeats.interval_60":"1 hour","heartbeats.interval_120":"2 hours","heartbeats.interval_720":"12 hours","heartbeats.interval_1440":"1 day","heartbeats.interval_10080":"1 week"},"zh":{"app.yes":"\u662f","app.no":"\u5426","dashboard.pending":":count \u4e2a\u6b63\u5728\u7b49\u5f85\u7684\u90e8\u7f72","dashboard.running":":count \u4e2a\u6b63\u5728\u8fd0\u884c\u7684\u90e8\u7f72","dashboard.deployment_number":"\u90e8\u7f72 #:id","deployments.completed":"\u5df2\u5b8c\u6210","deployments.completed_with_errors":"\u5df2\u5b8c\u6210\uff08\u6709\u9519\u8bef\uff09","deployments.pending":"\u6b63\u5728\u7b49\u5f85","deployments.deploying":"\u6b63\u5728\u90e8\u7f72","deployments.running":"\u6b63\u5728\u8fd0\u884c","deployments.cancelled":"\u5df2\u53d6\u6d88","deployments.failed":"\u5931\u8d25","variables.create":"\u6dfb\u52a0\u65b0\u53d8\u91cf","variables.edit":"\u7f16\u8f91\u53d8\u91cf","projects.create":"\u6dfb\u52a0\u65b0\u9879\u76ee","projects.edit":"\u7f16\u8f91\u9879\u76ee","projects.finished":"\u5df2\u5b8c\u6210","projects.pending":"\u6b63\u5728\u7b49\u5f85","projects.deploying":"\u6b63\u5728\u90e8\u7f72","projects.failed":"\u5931\u8d25","projects.not_deployed":"\u672a\u90e8\u7f72","checkUrls.create":"\u6dfb\u52a0\u65b0\u7684 URL","checkUrls.edit":"\u7f16\u8f91 URL","checkUrls.successful":"\u5728\u7ebf","checkUrls.failed":"\u79bb\u7ebf","checkUrls.untested":"\u672a\u77e5","checkUrls.length":"\u5206\u949f","checkUrls.log_title":"Failure Log","commands.create":"\u6dfb\u52a0\u65b0\u547d\u4ee4","commands.edit":"\u7f16\u8f91\u547d\u4ee4","groups.create":"\u6dfb\u52a0\u65b0\u9879\u76ee\u5206\u7ec4","groups.edit":"\u7f16\u8f91\u9879\u76ee\u5206\u7ec4","users.create":"\u6dfb\u52a0\u65b0\u7528\u6237","users.edit":"\u7f16\u8f91\u7528\u6237","templates.create":"\u6dfb\u52a0\u65b0\u6a21\u677f","templates.edit":"\u7f16\u8f91\u6a21\u677f","sharedFiles.create":"\u6dfb\u52a0\u65b0\u6587\u4ef6\u6216\u6587\u4ef6\u5939","sharedFiles.edit":"\u7f16\u8f91\u6587\u4ef6\u6216\u6587\u4ef6\u5939","configFiles.create":"\u6dfb\u52a0\u65b0\u6587\u4ef6","configFiles.edit":"\u7f16\u8f91\u6587\u4ef6","channels.create":"\u6dfb\u52a0\u65b0\u7684\u901a\u77e5","channels.edit":"\u7f16\u8f91\u901a\u77e5","channels.custom":"\u81ea\u5b9a\u4e49","channels.slack":"Slack \u901a\u77e5","channels.hipchat":"Hipchat","channels.twilio":"Twilio","channels.mail":"E-mail","channels.create_slack":"\u6dfb\u52a0\u65b0\u7684 slack \u901a\u77e5","channels.create_hipchat":"\u6dfb\u52a0\u65b0\u7684 Hipchat \u901a\u77e5","channels.create_twilio":"\u6dfb\u52a0\u65b0\u7684 Twilio \u901a\u77e5","channels.create_mail":"\u6dfb\u52a0\u65b0\u7684 e-mail \u901a\u77e5","channels.create_custom":"\u6dfb\u52a0\u65b0\u7684\u81ea\u5b9a\u4e49\u901a\u77e5","channels.edit_slack":"\u7f16\u8f91 slack \u901a\u77e5","channels.edit_hipchat":"\u7f16\u8f91 Hipchat \u901a\u77e5","channels.edit_twilio":"\u7f16\u8f91 Twilio \u901a\u77e5","channels.edit_mail":"\u7f16\u8f91 e-mail \u901a\u77e5","channels.edit_custom":"\u7f16\u8f91\u81ea\u5b9a\u4e49\u901a\u77e5","servers.create":"\u6dfb\u52a0\u65b0\u670d\u52a1\u5668","servers.edit":"\u7f16\u8f91\u670d\u52a1\u5668","servers.successful":"\u6210\u529f","servers.testing":"\u6b63\u5728\u6d4b\u8bd5","servers.failed":"\u5931\u8d25","servers.untested":"\u672a\u6d4b\u8bd5","servers.log_title":"Test Log","heartbeats.create":"\u6dfb\u52a0\u65b0\u5fc3\u8df3","heartbeats.edit":"\u7f16\u8f91\u5fc3\u8df3","heartbeats.ok":"\u5065\u5eb7","heartbeats.untested":"\u6b63\u5728\u7b49\u5f85\u5fc3\u8df3","heartbeats.missing":"\u4e22\u5931","heartbeats.interval_10":"10 \u5206\u949f","heartbeats.interval_30":"30 \u5206\u949f","heartbeats.interval_60":"1 \u5c0f\u65f6","heartbeats.interval_120":"2 \u5c0f\u65f6","heartbeats.interval_720":"12 \u5c0f\u65f6","heartbeats.interval_1440":"1 \u5929","heartbeats.interval_10080":"1 \u5468"},"ru":{"app.yes":"\u0414\u0430","app.no":"\u041d\u0435\u0442","dashboard.pending":":count \u043e\u0436\u0438\u0434\u0430\u044e\u0449\u0430\u044f \u0441\u0431\u043e\u0440\u043a\u0430|:count \u043e\u0436\u0438\u0434\u0430\u044e\u0449\u0438\u0445 \u0441\u0431\u043e\u0440\u043e\u043a","dashboard.running":":count \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u043d\u0430\u044f \u0441\u0431\u043e\u0440\u043a\u0430|:count \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u043d\u044b\u0445 \u0441\u0431\u043e\u0440\u043e\u043a","dashboard.deployment_number":"\u0421\u0431\u043e\u0440\u043a\u0430 #:id","deployments.completed":"\u0417\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0430","deployments.completed_with_errors":"\u0417\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0430 \u0441 \u043e\u0448\u0438\u0431\u043a\u0430\u043c\u0438","deployments.pending":"\u041e\u0436\u0438\u0434\u0430\u043d\u0438\u0435","deployments.deploying":"\u0421\u0431\u043e\u0440\u043a\u0430","deployments.running":"\u0420\u0430\u0431\u043e\u0442\u0430\u0435\u0442","deployments.cancelled":"\u041e\u0442\u043c\u0435\u043d\u0435\u043d\u0430","deployments.failed":"\u041f\u0440\u043e\u0432\u0430\u043b\u0435\u043d\u0430","variables.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u0443\u044e \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u0443\u044e","variables.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u0443\u044e","projects.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0439 \u043f\u0440\u043e\u0435\u043a\u0442","projects.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043f\u0440\u043e\u0435\u043a\u0442","projects.finished":"\u0417\u0430\u043a\u043e\u043d\u0447\u0435\u043d\u0430","projects.pending":"\u041e\u0436\u0438\u0434\u0430\u0435\u0442","projects.deploying":"\u0421\u043e\u0431\u0438\u0440\u0430\u0435\u0442\u0441\u044f","projects.failed":"\u041f\u0440\u043e\u0432\u0430\u043b\u0435\u043d\u0430","projects.not_deployed":"\u041d\u0435 \u0441\u043e\u0431\u0438\u0440\u0430\u043b\u0430\u0441\u044c","checkUrls.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0439 URL","checkUrls.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c URL","checkUrls.successful":"\u041e\u043d\u043b\u0430\u0439\u043d","checkUrls.failed":"\u041e\u0444\u0444\u043b\u0430\u0439\u043d","checkUrls.untested":"\u041d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u0435\u043d","checkUrls.length":"\u041c\u0438\u043d\u0443\u0442","checkUrls.log_title":"Failure Log","commands.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u0443\u044e \u043a\u043e\u043c\u0430\u043d\u0434\u0443","commands.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043a\u043e\u043c\u0430\u043d\u0434\u0443","groups.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u0443\u044e \u0433\u0440\u0443\u043f\u043f\u0443","groups.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0433\u0440\u0443\u043f\u043f\u0443","users.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0433\u043e \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f","users.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f","templates.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0439 \u0448\u0430\u0431\u043b\u043e\u043d","templates.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0448\u0430\u0431\u043b\u043e\u043d","sharedFiles.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0439 \u0444\u0430\u0439\u043b \u0438\u043b\u0438 \u0434\u0438\u0440\u0435\u043a\u0442\u043e\u0440\u0438\u044e","sharedFiles.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0444\u0430\u0439\u043b \u0438\u043b\u0438 \u0434\u0438\u0440\u0435\u043a\u0442\u043e\u0440\u0438\u044e","configFiles.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0439 \u0444\u0430\u0439\u043b","configFiles.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0444\u0430\u0439\u043b","channels.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0435 \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435","channels.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435","channels.custom":"\u0421\u0432\u043e\u0439 \u0442\u0438\u043f","channels.slack":"Slack","channels.hipchat":"Hipchat","channels.twilio":"Twilio","channels.mail":"E-mail","channels.create_slack":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0435 \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u0432 Slack","channels.create_hipchat":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0435 \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u0432 Hipchat","channels.create_twilio":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0435 \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u0432 Twilio","channels.create_mail":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0435 \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u043f\u043e E-mail","channels.create_custom":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u043e\u0435 \u0441\u0432\u043e\u0439 \u0442\u0438\u043f \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u044f","channels.edit_slack":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u0432 Slack","channels.edit_hipchat":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u0432 Hipchat","channels.edit_twilio":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u0432 Twilio","channels.edit_mail":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u043f\u043e E-mail","channels.edit_custom":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u0441\u0432\u043e\u0439 \u0442\u0438\u043f \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u044f","servers.create":"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u0432\u044b\u0439 \u0441\u0435\u0440\u0432\u0435\u0440","servers.edit":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0441\u0435\u0440\u0432\u0435\u0440","servers.successful":"\u0423\u0441\u043f\u0435\u0448\u043d\u043e","servers.testing":"\u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u0442\u0441\u044f","servers.failed":"\u041f\u0440\u043e\u0432\u0430\u043b\u0435\u043d\u043e","servers.untested":"\u041d\u0435 \u043f\u0440\u043e\u0432\u0435\u0440\u0435\u043d\u043e","servers.log_title":"Test Log","heartbeats.create":"Add a new heartbeat","heartbeats.edit":"Edit the heartbeat","heartbeats.ok":"Healthy","heartbeats.untested":"Waiting for Heartbeat","heartbeats.missing":"Missing in Action","heartbeats.interval_10":"10 minutes","heartbeats.interval_30":"30 minutes","heartbeats.interval_60":"1 hour","heartbeats.interval_120":"2 hours","heartbeats.interval_720":"12 hours","heartbeats.interval_1440":"1 day","heartbeats.interval_10080":"1 week"}});
$.ajaxPrefilter(function(options, originalOptions, jqXHR) {
    jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="token"]').attr('content'));
});

var app = app || {};

// FIXME: There has to be a cleaner way to do this surely?
function parseOutput(output) {
  return output.replace(/<\/error>/g, '</span>')
    .replace(/<\/info>/g, '</span>')
    .replace(/<error>/g, '<span class="text-red">')
    .replace(/<info>/g, '<span class="text-default">');
}

toastr.options.closeButton = true;
toastr.options.progressBar = true;
toastr.options.preventDuplicates = true;
toastr.options.closeMethod = 'fadeOut';
toastr.options.closeDuration = 300;
toastr.options.closeEasing = 'swing';
toastr.options.positionClass = 'toast-bottom-right';
toastr.options.timeOut = 5000;
toastr.options.extendedTimeOut = 7000;

(function ($) {

    // Don't need to try and connect to the web socket when not logged in
    if (window.location.href.match(/login|password/) != null) {
        return;
    }

    Lang.setLocale($('meta[name="locale"]').attr('content'));

    var FINISHED     = 0;
    var PENDING      = 1;
    var DEPLOYING    = 2;
    var FAILED       = 3;
    var NOT_DEPLOYED = 4;

    var DEPLOYMENT_COMPLETED = 0;
    var DEPLOYMENT_PENDING   = 1;
    var DEPLOYMENT_DEPLOYING = 2;
    var DEPLOYMENT_FAILED    = 3;
    var DEPLOYMENT_ERRORS    = 4;
    var DEPLOYMENT_CANCELLED = 5;

    app.project_id = app.project_id || null;

    app.listener = io.connect($('meta[name="socket_url"]').attr('content'), {
        query: 'jwt=' + $('meta[name="jwt"]').attr('content'),
        transports: ['websocket', 'polling']
    });

    app.connection_error = false;

    app.listener.on('connect_error', function(error) {
        if (!app.connection_error) {
            $('#socket_offline').show();
        }

        app.connection_error = true;
    });

    app.listener.on('connect', function() {
        $('#socket_offline').hide();
        app.connection_error = false;
    });

    app.listener.on('reconnect', function() {
        $('#socket_offline').hide();
        app.connection_error = false;
    });

    // Navbar deployment status
    // FIXME: Convert these menus to backbone
    // FIXME: Convert the project and deployments to backbone
    // TODO: Update the timeline
    app.listener.on('deployment:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
        updateNavBar(data);

        //var project = $('#project_' + data.model.project_id);

        if ($('#timeline').length > 0) {
            updateTimeline();
        }

        var deployment  = $('#deployment_' + data.model.id);

        if (deployment.length > 0) {

            $('td:nth-child(4)', deployment).text(data.model.committer);

            if (data.model.commit_url) {
                $('td:nth-child(5)', deployment).html('<a href="' + data.model.commit_url + '" target="_blank">' + data.model.short_commit + '</a>');
            } else {
                $('td:nth-child(5)', deployment).text(data.model.short_commit);
            }

            var icon_class = 'clock-o';
            var label_class = 'info';
            var label = Lang.get('deployments.pending');
            var done = false;
            var success = false;

            data.model.status = parseInt(data.model.status);
            var status = $('td:nth-child(7) span.label', deployment);

            if (data.model.status === DEPLOYMENT_COMPLETED) {
                icon_class = 'check';
                label_class = 'success';
                label = Lang.get('deployments.completed');
                done = true;
                success = true;
            } else if (data.model.status === DEPLOYMENT_DEPLOYING) {
                icon_class = 'spinner fa-pulse';
                label_class = 'warning';
                label = Lang.get('deployments.running');
            } else if (data.model.status === DEPLOYMENT_FAILED) {
                icon_class = 'warning';
                label_class = 'danger';
                label = Lang.get('deployments.failed');
                done = true;
            } else if (data.model.status === DEPLOYMENT_ERRORS) {
                icon_class = 'warning';
                label_class = 'success';
                label = Lang.get('deployments.completed_with_errors');
                done = true;
                success = true;
            } else if (data.model.status === DEPLOYMENT_CANCELLED) {
                icon_class = 'warning';
                label_class = 'danger';
                label = Lang.get('deployments.cancelled');
                done = true;
            }

            if (done) {
                $('button#deploy_project:disabled').removeAttr('disabled');
                $('td:nth-child(8) a.btn-cancel', deployment).remove();

                if (success) {
                    $('button.btn-rollback').removeClass('hide');
                }
            }

            status.attr('class', 'label label-' + label_class);
            $('i', status).attr('class', 'fa fa-' + icon_class);
            $('span', status).text(label);
        } else if ($('#timeline').length === 0) { // Don't show on dashboard
            // FIXME: Also don't show if viewing the deployment, or the project the deployment is for

            var toast_title = Lang.get('dashboard.deployment_number', {
                'id': data.model.id
            });

            if (data.model.status === DEPLOYMENT_COMPLETED) {
                toastr.success(toast_title + ' - ' + Lang.get('deployments.completed'), data.model.project_name);
            } else if (data.model.status === DEPLOYMENT_FAILED) {
                toastr.error(toast_title + ' - ' + Lang.get('deployments.failed'), data.model.project_name);
            } else if (data.model.status === DEPLOYMENT_ERRORS) {
                toastr.warning(toast_title + ' - ' + Lang.get('deployments.completed_with_errors'), data.model.project_name);
            } // FIXME: Add cancelled
        }
    });

    app.listener.on('group:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
        $('#sidebar_group_' + data.model.id).html(data.model.name);
    });

    app.listener.on('project:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
        $('#sidebar_project_' + data.model.id).html(data.model.name);

        var project = $('#project_' + data.model.id);

        if (project.length > 0) {

            var icon_class = 'question-circle';
            var label_class = 'primary';
            var label = Lang.get('projects.not_deployed');

            data.model.status = parseInt(data.model.status);
            var status = $('td:nth-child(3) span.label', project);

            if (data.model.status === FINISHED) {
                icon_class = 'check';
                label_class = 'success';
                label = Lang.get('projects.finished');
            } else if (data.model.status === DEPLOYING) {
                icon_class = 'spinner fa-pulse';
                label_class = 'warning';
                label = Lang.get('projects.deploying');
            } else if (data.model.status === FAILED) {
                icon_class = 'warning';
                label_class = 'danger';
                label = Lang.get('projects.failed');
            } else if (data.model.status === PENDING) {
                icon_class = 'clock-o';
                label_class = 'info';
                label = Lang.get('projects.pending');
            }

            $('td:first a', project).text(data.model.name);
            $('td:nth-child(2)', project).text(moment(data.model.last_run).format('Do MMMM YYYY h:mm:ss A'));
            status.attr('class', 'label label-' + label_class);
            $('i', status).attr('class', 'fa fa-' + icon_class);
            $('span', status).text(label);
        }
    });

    app.listener.on('project:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
        $('#sidebar_project_' + data.model.id).parent('li').remove();

        if (parseInt(data.model.id) === parseInt(app.project_id)) {
            window.location.href = '/';
        }
    });

    // FIXME: This is cheating
    function updateTimeline() {
        $.ajax({
            type: 'GET',
            url: '/timeline'
        }).success(function (response) {
            $('#timeline').html(response);
        });
    }

    function updateNavBar(data) {
        data.model.time = moment(data.model.started_at).format('h:mm:ss A');
        data.model.url = '/deployment/' + data.model.id;

        $('#deployment_info_' + data.model.id).remove();
        $('#pending_menu, #deploying_menu').show();

        var template = _.template($('#deployment-list-template').html());
        var html = template(data.model);

        if (data.model.status === DEPLOYMENT_PENDING) {
            $('#pending_menu ul.menu').append(html);
        }
        else if (data.model.status === DEPLOYMENT_DEPLOYING) {
            $('#deploying_menu ul.menu').append(html);
        }

        var pending = $('#pending_menu ul.menu li').length;
        var deploying = $('#deploying_menu ul.menu li').length;

        var pending_label = Lang.choice('dashboard.pending', pending, {
            'count': pending
        });

        if (pending === 0) {
            $('#pending_menu').hide();
        }

        var deploying_label = Lang.choice('dashboard.running', deploying, {
            'count': deploying
        });

        if (deploying === 0) {
            $('#deploying_menu').hide();
        }

        $('#deploying_menu span.label-warning').html(deploying);
        $('#deploying_menu .header').text(deploying_label);

        $('#pending_menu span.label-info').html(pending);
        $('#pending_menu .header').text(pending_label);
    }

    $(document).ready(function () {
        if ($('#pending_menu ul.menu li').length > 0) {
            $('#pending_menu').show();
        }

        if ($('#deploying_menu ul.menu li').length > 0) {
            $('#deploying_menu').show();
        }
    });

})(jQuery);

var app = app || {};

(function ($) {
    var selectOptions = {
        width: '80%',
        minimumResultsForSearch: 6
    };

    $('select.deployment-source').select2(selectOptions);

    if ($('div.tab-content #deployments').length > 0) {
        app.listener.on('project:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
            if (parseInt(data.model.id) === parseInt(app.project_id)) {
                resetOptions('select.deployment-source#deployment_branch', data.model.branches);
                resetOptions('select.deployment-source#deployment_tag', data.model.tags.reverse());

                var dialog = $('.modal#reason');
                resetDialog(dialog);
            }
        });
    }

    function resetOptions(selector, data) {
        var options = selectOptions;
        options.data = data;

        $('option', selector).remove();

        $(selector).select2('destroy');
        $(selector).select2(options);
    }

    $('button.btn-refresh-branches').on('click', function (event) {
        var target = $(event.currentTarget);
        var project_id = target.data('project-id');
        var icon = $('i', target);
        var dialog = target.parents('.modal');

        if ($('.fa-spin', target).length > 0) {
            return;
        }

        $(':input', dialog).not('.close').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        icon.addClass('fa-spin');

        $.ajax({
            type: 'POST',
            url: '/projects/' + project_id + '/refresh'
        }).fail(function () {
            // FIXME: Show error?
            resetDialog(dialog);
        });
    });

    function resetDialog(dialog) {
        $(':input', dialog).not('.close').removeAttr('disabled');
        $('button.close', dialog).show();
        $('i.fa-spin', dialog).removeClass('fa-spin');
    }

    $('.deployment-source:radio').on('change', function (event) {
        var target = $(event.currentTarget);

        $('div.deployment-source-container').hide();
        if (target.val() === 'branch') {
            $('#deployment_branch').parent('div').show();
        } else if (target.val() === 'tag') {
            $('#deployment_tag').parent('div').show();
        }
    });

    $('#reason').on('show.bs.modal', function (event) {
        var modal = $(this);
        $('.callout-danger', modal).hide();
    });

    $('#reason button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');
        var source = $('input[name=source]:checked').val();

        $('.has-error', source).removeClass('has-error');

        if (source === 'branch' || source === 'tag') {
            if ($('#deployment_' + source).val() === '') {
                $('#deployment_' + source).parentsUntil('div').addClass('has-error');

                $('.callout-danger', dialog).show();
                event.stopPropagation();
                return;
            }
        }

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        $('button.close', dialog).hide();
    });

    // FIXME: This seems very wrong
    $('#project').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('projects.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();
        $('#template-list', modal).hide();

        $('.nav-tabs a:first', modal).tab('show');

        if (button.hasClass('btn-edit')) {
            title = Lang.get('projects.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#template-list', modal).show();
            $('#project_id').val('');
            $('#project_name').val('');
            $('#project_repository').val('');
            $('#project_branch').val('master');
            $('#project_group_id').val($("#project_group_id option:first").val());
            $('#project_template_id').val($("#project_template_id option:first").val());
            $('#project_builds_to_keep').val(10);
            $('#project_url').val('');
            $('#project_build_url').val('');
            $('#project_allow_other_branch').prop('checked', true);
            $('#project_include_dev').prop('checked', false);
            $('#project_private_key').val('');
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#project button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var project = app.Projects.get($('#project_id').val());

        project.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#project button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var project_id = $('#project_id').val();

        if (project_id) {
            var project = app.Projects.get(project_id);
        } else {
            var project = new app.Project();
        }

        project.save({
            name:               $('#project_name').val(),
            repository:         $('#project_repository').val(),
            branch:             $('#project_branch').val(),
            group_id:           parseInt($('#project_group_id').val()),
            builds_to_keep:     $('#project_builds_to_keep').val(),
            url:                $('#project_url').val(),
            build_url:          $('#project_build_url').val(),
            template_id:        $('#project_template_id') ? parseInt($('#project_template_id').val()) : null,
            allow_other_branch: $('#project_allow_other_branch').is(':checked'),
            include_dev:        $('#project_include_dev').is(':checked'),
            private_key:        $('#project_private_key').val()
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!project_id) {
                    app.Projects.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form :input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }

                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    $('#project_group_id').select2({
        width: '100%',
        minimumResultsForSearch: Infinity
    });

    $('#project_template_id').select2({
        width: '100%',
        minimumResultsForSearch: Infinity
    });

    app.Project = Backbone.Model.extend({
        urlRoot: '/admin/projects'
    });

    var Projects = Backbone.Collection.extend({
        model: app.Project
    });

    app.Projects = new Projects();

    app.ProjectsTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#project_list tbody');

            $('#project_list').hide();
            $('#no_projects').show();

            this.listenTo(app.Projects, 'add', this.addOne);
            this.listenTo(app.Projects, 'reset', this.addAll);
            this.listenTo(app.Projects, 'remove', this.addAll);
            this.listenTo(app.Projects, 'all', this.render);

            app.listener.on('project:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var project = app.Projects.get(parseInt(data.model.id));

                if (project) {
                    project.set(data.model);
                }
            });

            app.listener.on('project:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                app.Projects.add(data.model);

                // Append to the menu
                if ($('#sidebar_project_' + data.model.id).length === 0) {
                    var template = _.template($('#project-sidebar-template').html());
                    $('#group_' + data.model.group_id + '_projects').append(template(data.model));
                }
            });

            app.listener.on('project:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var project = app.Projects.get(parseInt(data.model.id));

                if (project) {
                    app.Projects.remove(project);
                }

                $('#project_' + data.model.id).parent('li').remove();

                if (parseInt(data.model.id) === parseInt(app.project_id)) {
                    window.location.href = '/';
                }
            });
        },
        render: function () {
            if (app.Projects.length) {
                $('#no_projects').hide();
                $('#project_list').show();
            } else {
                $('#no_projects').show();
                $('#project_list').hide();
            }
        },
        addOne: function (project) {
            var view = new app.ProjectView({
                model: project
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.Projects.each(this.addOne, this);
        }
    });

    app.ProjectView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editProject'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#project-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            data.deploy = data.last_run ? moment(data.last_run).format('Do MMMM YYYY h:mm:ss A') : false;

            this.$el.html(this.template(data));

            return this;
        },
        editProject: function() {
            $('#project_id').val(this.model.id);
            $('#project_name').val(this.model.get('name'));
            $('#project_repository').val(this.model.get('repository'));
            $('#project_branch').val(this.model.get('branch'));
            $('#project_group_id').val(this.model.get('group_id'));
            $('#project_builds_to_keep').val(this.model.get('builds_to_keep'));
            $('#project_url').val(this.model.get('url'));
            $('#project_build_url').val(this.model.get('build_url'));
            $('#project_allow_other_branch').prop('checked', (this.model.get('allow_other_branch') === true));
            $('#project_include_dev').prop('checked', (this.model.get('include_dev') === true));
            $('#project_private_key').val('');
        }
    });

    $('#new_webhook').on('click', function(event) {
        var target = $(event.currentTarget);
        var project_id = target.data('project-id');
        var icon = $('i', target);

        if ($('.fa-spin', target).length > 0) {
            return;
        }

        target.attr('disabled', 'disabled');

        icon.addClass('fa-spin');

        $.ajax({
            type: 'GET',
            url: '/webhook/' + project_id + '/refresh'
        }).fail(function (response) {

        }).done(function (data) {
            $('#webhook').html(data.url);
        }).always(function () {
            icon.removeClass('fa-spin');
            target.removeAttr('disabled');
        });
    });
})(jQuery);

var app = app || {};

(function ($) {
    // FIXME: This seems very wrong
    $('#template').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('templates.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('templates.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#template_id').val('');
            $('#template_name').val('');
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#template button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var template = app.Templates.get($('#template_id').val());

        template.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#template button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var template_id = $('#template_id').val();

        if (template_id) {
            var template = app.Templates.get(template_id);
        } else {
            var template = new app.Template();
        }

        template.save({
            name: $('#template_name').val()
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!template_id) {
                    app.Templates.add(response);

                    window.location.href = '/admin/templates/' + response.id;
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.Template = Backbone.Model.extend({
        urlRoot: '/admin/templates'
    });

    var Templates = Backbone.Collection.extend({
        model: app.Template
    });

    app.Templates = new Templates();

    app.TemplatesTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#template_list tbody');

            $('#template_list').hide();
            $('#no_templates').show();

            this.listenTo(app.Templates, 'add', this.addOne);
            this.listenTo(app.Templates, 'reset', this.addAll);
            this.listenTo(app.Templates, 'remove', this.addAll);
            this.listenTo(app.Templates, 'all', this.render);

            app.listener.on('template:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var template = app.Templates.get(parseInt(data.model.id));

                if (template) {
                    template.set(data.model);
                }
            });

            app.listener.on('template:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                app.Templates.add(data.model);
            });

            app.listener.on('template:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var template = app.Templates.get(parseInt(data.model.id));

                if (template) {
                    app.Templates.remove(template);
                }
            });
        },
        render: function () {
            if (app.Templates.length) {
                $('#no_templates').hide();
                $('#template_list').show();
            } else {
                $('#no_templates').show();
                $('#template_list').hide();
            }
        },
        addOne: function (template) {
            var view = new app.TemplateView({
                model: template
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.Templates.each(this.addOne, this);
        }
    });

    app.TemplateView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editTemplate'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#template-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            this.$el.html(this.template(data));

            return this;
        },
        editTemplate: function() {
            $('#template_id').val(this.model.id);
            $('#template_name').val(this.model.get('name'));
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
    var SUCCESSFUL = 0;
    var UNTESTED   = 1;
    var FAILED     = 2;
    var TESTING    = 3;

    $('#server_list table').sortable({
        containerSelector: 'table',
        itemPath: '> tbody',
        itemSelector: 'tr',
        placeholder: '<tr class="placeholder"/>',
        delay: 500,
        onDrop: function (item, container, _super) {
            _super(item, container);

            var ids = [];
            $('tbody tr td:first-child', container.el[0]).each(function (idx, element) {
                ids.push($(element).data('server-id'));
            });

            $.ajax({
                url: '/servers/reorder',
                method: 'POST',
                data: {
                    servers: ids
                }
            });
        }
    });

    // FIXME: This seems very wrong
    $('#server').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('servers.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();
        $('#add-server-command', modal).hide();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('servers.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#server_id').val('');
            $('#server_name').val('');
            $('#server_address').val('');
            $('#server_port').val('22');
            $('#server_user').val('');
            $('#server_path').val('');
            $('#server_deploy_code').prop('checked', true);
            $('#add-server-command', modal).show();
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#server #server_name').autocomplete({
        serviceUrl: '/servers/autocomplete',
        dataType: 'json',
        noCache: true,
        preserveInput: true,
        transformResult: function (response) {
            return {
                suggestions: $.map(response.suggestions, function (dataItem) {
                    var value = dataItem.name + ' (' + dataItem.user + '@' + dataItem.ip_address + ')';
                    return {
                      value: value,
                      data: dataItem
                    };
                })
            };
        },
        onSelect: function (suggestion) {
            var server = suggestion.data;
            $('#server_name').val(server.name);
            $('#server_address').val(server.ip_address);
            $('#server_port').val(server.port);
            $('#server_user').val(server.user);
            $('#server_path').val(server.path);
            $('#server_deploy_code').prop('checked', server.deploy_code);
        }
    });

    // FIXME: This seems very wrong
    $('#server button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var server = app.Servers.get($('#server_id').val());

        server.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#server button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var server_id = $('#server_id').val();

        if (server_id) {
            var server = app.Servers.get(server_id);
        } else {
            var server = new app.Server();
        }

        server.save({
            name:         $('#server_name').val(),
            ip_address:   $('#server_address').val(),
            port:         $('#server_port').val(),
            user:         $('#server_user').val(),
            path:         $('#server_path').val(),
            deploy_code:  $('#server_deploy_code').is(':checked'),
            project_id:   parseInt($('input[name="project_id"]').val()),
            add_commands: $('#server_commands').is(':checked')
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!server_id) {
                    app.Servers.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    $('#server [data-server-template-id]').on('click', function () {
        var server_template_id = $(this).data('server-template-id');
        var server_template = app.ServerTemplates.get(server_template_id);
        $('#server_name').val(server_template.get('name'));
        $('#server_address').val(server_template.get('ip_address'));
        $('#server_port').val(server_template.get('port'));
        $('.nav-tabs a[href="#server_details"]').tab('show');
    });

    app.Server = Backbone.Model.extend({
        urlRoot: '/servers'
    });

    var Servers = Backbone.Collection.extend({
        model: app.Server,
        comparator: function(serverA, serverB) {
            if (serverA.get('name') > serverB.get('name')) {
                return -1; // before
            } else if (serverA.get('name') < serverB.get('name')) {
                return 1; // after
            }

            return 0; // equal
        }
    });

    app.Servers = new Servers();

    app.ServersTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#server_list tbody');

            $('#no_servers').show();
            $('#server_list').hide();

            this.listenTo(app.Servers, 'add', this.addOne);
            this.listenTo(app.Servers, 'reset', this.addAll);
            this.listenTo(app.Servers, 'remove', this.addAll);
            this.listenTo(app.Servers, 'all', this.render);

            app.listener.on('server:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var server = app.Servers.get(parseInt(data.model.id));

                if (server) {
                    server.set(data.model);
                }
            });

            app.listener.on('server:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                if (parseInt(data.model.project_id) === parseInt(app.project_id)) {
                    app.Servers.add(data.model);
                }
            });

            app.listener.on('server:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var server = app.Servers.get(parseInt(data.model.id));

                if (server) {
                    app.Servers.remove(server);
                }
            });
        },
        render: function () {
            if (app.Servers.length) {
                $('#no_servers').hide();
                $('#server_list').show();
            } else {
                $('#no_servers').show();
                $('#server_list').hide();
            }
        },
        addOne: function (server) {

            var view = new app.ServerView({
                model: server
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.Servers.each(this.addOne, this);
        }
    });

    app.ServerView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-test': 'testConnection',
            'click .btn-edit': 'editServer',
            'click .btn-view': 'viewLog'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#server-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            data.status_css = 'primary';
            data.icon_css   = 'question';
            data.status     = Lang.get('servers.untested');
            data.has_log    = false;

            if (parseInt(this.model.get('status')) === SUCCESSFUL) {
                data.status_css = 'success';
                data.icon_css   = 'check';
                data.status     = Lang.get('servers.successful');
            } else if (parseInt(this.model.get('status')) === TESTING) {
                data.status_css = 'warning';
                data.icon_css   = 'spinner fa-pulse';
                data.status     = Lang.get('servers.testing');
            } else if (parseInt(this.model.get('status')) === FAILED) {
                data.status_css = 'danger';
                data.icon_css   = 'warning';
                data.status     = Lang.get('servers.failed');
                data.has_log    = data.connect_log ? true : false;
            }

            this.$el.html(this.template(data));

            return this;
        },
        editServer: function() {
            // FIXME: Sure this is wrong?
            $('#server_id').val(this.model.id);
            $('#server_name').val(this.model.get('name'));
            $('#server_address').val(this.model.get('ip_address'));
            $('#server_port').val(this.model.get('port'));
            $('#server_user').val(this.model.get('user'));
            $('#server_path').val(this.model.get('path'));

            $('#server_deploy_code').prop('checked', (this.model.get('deploy_code') === true));
        },
        viewLog: function() {
            var modal = $('div.modal#result');
            var title = Lang.get('servers.log_title');

            modal.find('pre').html(parseOutput(this.model.get('connect_log')));
            modal.find('.modal-title span').text(title);
        },
        testConnection: function() {
            if (parseInt(this.model.get('status')) === TESTING) {
                return;
            }

            this.model.set({
                status: TESTING
            });

            var that = this;
            $.ajax({
                type: 'POST',
                //url: '/projects/' + this.model.get('project_id') + this.model.urlRoot + '/' + this.model.id + '/test'
                url: this.model.urlRoot + '/' + this.model.id + '/test'
            }).fail(function (response) {
                that.model.set({
                    status: FAILED
                });
            });
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
    var SUCCESSFUL = 0;
    var UNTESTED   = 1;
    var FAILED     = 2;
    var TESTING    = 3;

    // FIXME: This seems very wrong
    $('#server_template').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('servers.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();
        $('#add-server-command', modal).hide();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('servers.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#server_template_id').val('');
            $('#server_template_name').val('');
            $('#server_template_address').val('');
            $('#server_template_port').val('22');
            $('#add-server-command', modal).show();
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#server_template button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var serverTemplate = app.ServerTemplates.get($('#server_template_id').val());

        serverTemplate.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#server_template button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var server_template_id = $('#server_template_id').val();

        if (server_template_id) {
            var serverTemplate = app.ServerTemplates.get(server_template_id);
        } else {
            var serverTemplate = new app.ServerTemplate();
        }

        serverTemplate.save({
            name:         $('#server_template_name').val(),
            ip_address:   $('#server_template_address').val(),
            port:         $('#server_template_port').val(),
            add_commands: $('#server_commands').is(':checked')
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!server_template_id) {
                    app.ServerTemplates.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });


    app.ServerTemplate = Backbone.Model.extend({
        urlRoot: '/admin/servers'
    });

    var ServerTemplates = Backbone.Collection.extend({
        model: app.ServerTemplate,
        comparator: function(serverA, serverB) {
            if (serverA.get('name') > serverB.get('name')) {
                return -1; // before
            } else if (serverA.get('name') < serverB.get('name')) {
                return 1; // after
            }

            return 0; // equal
        }
    });

    app.ServerTemplates = new ServerTemplates();

    app.ServerTemplatesTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#server_template_list tbody');

            $('#no_server_templates').show();
            $('#server_template_list').hide();

            this.listenTo(app.ServerTemplates, 'add', this.addOne);
            this.listenTo(app.ServerTemplates, 'reset', this.addAll);
            this.listenTo(app.ServerTemplates, 'remove', this.addAll);
            this.listenTo(app.ServerTemplates, 'all', this.render);

            app.listener.on('serverTemplate:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var serverTemplate = app.ServerTemplates.get(parseInt(data.model.id));

                if (serverTemplate) {
                    serverTemplate.set(data.model);
                }
            });

            app.listener.on('serverTemplate:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                if (parseInt(data.model.project_id) === parseInt(app.project_id)) {
                    app.ServerTemplates.add(data.model);
                }
            });

            app.listener.on('serverTemplate:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var serverTemplate = app.Servers.get(parseInt(data.model.id));

                if (serverTemplate) {
                    app.ServerTemplates.remove(serverTemplate);
                }
            });
        },
        render: function () {
            if (app.ServerTemplates.length) {
                $('#no_server_templates').hide();
                $('#server_template_list').show();
            } else {
                $('#no_server_templates').show();
                $('#server_template_list').hide();
            }
        },
        addOne: function (serverTemplate) {
            var view = new app.ServerTemplateView({
                model: serverTemplate
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.ServerTemplates.each(this.addOne, this);
        }
    });

    app.ServerTemplateView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-test': 'testConnection',
            'click .btn-edit': 'editServerTemplate'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#server-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            data.status_css = 'primary';
            data.icon_css   = 'question';
            data.status     = Lang.get('servers.untested');

            if (parseInt(this.model.get('status')) === SUCCESSFUL) {
                data.status_css = 'success';
                data.icon_css   = 'check';
                data.status     = Lang.get('servers.successful');
            } else if (parseInt(this.model.get('status')) === TESTING) {
                data.status_css = 'warning';
                data.icon_css   = 'spinner fa-pulse';
                data.status     = Lang.get('servers.testing');
            } else if (parseInt(this.model.get('status')) === FAILED) {
                data.status_css = 'danger';
                data.icon_css   = 'warning';
                data.status     = Lang.get('servers.failed');
            }

            this.$el.html(this.template(data));

            return this;
        },
        editServerTemplate: function() {
            // FIXME: Sure this is wrong?
            $('#server_template_id').val(this.model.id);
            $('#server_template_name').val(this.model.get('name'));
            $('#server_template_address').val(this.model.get('ip_address'));
            $('#server_template_port').val(this.model.get('port'));
        },
        testConnection: function() {
            if (parseInt(this.model.get('status')) === TESTING) {
                return;
            }

            this.model.set({
                status: TESTING
            });

            var that = this;
            $.ajax({
                type: 'POST',
                //url: '/projects/' + this.model.get('project_id') + this.model.urlRoot + '/' + this.model.id + '/test'
                url: this.model.urlRoot + '/' + this.model.id + '/test'
            }).fail(function (response) {
                that.model.set({
                    status: FAILED
                });
            });
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
    var OK       = 0;
    var UNTESTED = 1;
    var MISSING  = 2;

    // FIXME: This seems very wrong
    $('#heartbeat').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('heartbeats.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('heartbeats.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#heartbeat_id').val('');
            $('#heartbeat_name').val('');
            $('#heartbeat_interval_30').prop('checked', true);
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#heartbeat button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var heartbeat = app.Heartbeats.get($('#heartbeat_id').val());

        heartbeat.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#heartbeat button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var heartbeat_id = $('#heartbeat_id').val();

        if (heartbeat_id) {
            var heartbeat = app.Heartbeats.get(heartbeat_id);
        } else {
            var heartbeat = new app.Heartbeat();
        }

        heartbeat.save({
            name:        $('#heartbeat_name').val(),
            interval:    parseInt($('input[name=interval]:checked').val()),
            project_id:  parseInt($('input[name="project_id"]').val())
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!heartbeat_id) {
                    app.Heartbeats.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.Heartbeat = Backbone.Model.extend({
        urlRoot: '/heartbeats'
    });

    var Heartbeats = Backbone.Collection.extend({
        model: app.Heartbeat,
        comparator: function(heartbeatA, heartbeatB) {
            if (heartbeatA.get('name') > heartbeatB.get('name')) {
                return -1; // before
            } else if (heartbeatA.get('name') < heartbeatB.get('name')) {
                return 1; // after
            }

            return 0; // equal
        }
    });

    app.Heartbeats = new Heartbeats();

    app.HeartbeatsTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#heartbeat_list tbody');

            $('#no_heartbeats').show();
            $('#heartbeat_list').hide();

            this.listenTo(app.Heartbeats, 'add', this.addOne);
            this.listenTo(app.Heartbeats, 'reset', this.addAll);
            this.listenTo(app.Heartbeats, 'remove', this.addAll);
            this.listenTo(app.Heartbeats, 'all', this.render);

            app.listener.on('heartbeat:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var heartbeat = app.Heartbeats.get(parseInt(data.model.id));

                if (heartbeat) {
                    heartbeat.set(data.model);
                }
            });

            app.listener.on('heartbeat:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                if (parseInt(data.model.project_id) === parseInt(app.project_id)) {
                    app.Heartbeats.add(data.model);
                }
            });

            app.listener.on('heartbeat:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var heartbeat = app.Heartbeats.get(parseInt(data.model.id));

                if (heartbeat) {
                    app.Heartbeats.remove(heartbeat);
                }
            });
        },
        render: function () {
            if (app.Heartbeats.length) {
                $('#no_heartbeats').hide();
                $('#heartbeat_list').show();
            } else {
                $('#no_heartbeats').show();
                $('#heartbeat_list').hide();
            }
        },
        addOne: function (heartbeat) {

            var view = new app.HeartbeatView({
                model: heartbeat
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.Heartbeats.each(this.addOne, this);
        }
    });

    app.HeartbeatView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editHeartbeat'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#heartbeat-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            data.status_css = 'primary';
            data.icon_css   = 'question';
            data.status     = Lang.get('heartbeats.untested');
            data.has_run    = false;

            if (parseInt(this.model.get('status')) === OK) {
                data.status_css = 'success';
                data.icon_css   = 'check';
                data.status     = Lang.get('heartbeats.ok');
                data.has_run    = true;
            } else if (parseInt(this.model.get('status')) === MISSING) {
                data.status_css = 'danger';
                data.icon_css   = 'warning';
                data.status     = Lang.get('heartbeats.missing');
                data.has_run    = data.last_activity ? true : false;
            }

            data.interval_label = Lang.get('heartbeats.interval_' + data.interval);

            data.formatted_date = '';
            if (data.has_run) {
                data.formatted_date = moment(data.last_activity).format('Do MMMM YYYY h:mm:ss A');
            }

            this.$el.html(this.template(data));

            return this;
        },
        editHeartbeat: function() {
            // FIXME: Sure this is wrong?
            $('#heartbeat_id').val(this.model.id);
            $('#heartbeat_name').val(this.model.get('name'));
            $('#heartbeat_interval_' + this.model.get('interval')).prop('checked', true);
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
    // FIXME: This seems very wrong
    $('#notification').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.callout-warning', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            $('.btn-danger', modal).show();
        } else {
            $('#notification_id').val('');
            $('#notification_name').val('');
            $('#notification_type').val('');
            $('#notification :input[id^=notification_config]').val('');
            $('#notification .channel-config input[type=checkbox]').prop('checked', true);
            $('#notification .modal-footer').hide();
            $('.channel-config').hide();
            $('#channel-type').show();
            modal.find('.modal-title span').text(Lang.get('channels.create'));
        }
    });

    $('#notification #channel-type a.btn-app').on('click', function(event) {
        var button = $(event.currentTarget);
        var modal = $('#notification');

        if (button.attr('disabled')) {
            $('.callout-warning', modal).show();
            return;
        }

        $('.callout-warning', modal).hide();

        var type = button.data('type');
        setTitleWithIcon(type, 'create');
    });

    function setTitleWithIcon(type, action) {
        $('#notification .modal-title span').text(Lang.get('channels.' + action + '_' + type));

        var element = $('#notification .modal-title i').removeClass().addClass('fa');
        var icon = 'cogs';

        if (type === 'slack') {
            icon = 'slack';
        } else if (type === 'hipchat') {
            element.addClass('fa-flip-horizontal');
            icon = 'comment-o';
        } else if (type === 'mail') {
            icon = 'envelope-o';
        } else if (type === 'twilio') {
            icon = 'mobile';
        }

        element.addClass('fa-' + icon);

        $('#notification .modal-footer').show();
        $('.channel-config').hide();
        $('#channel-type').hide();
        $('#channel-name').show();
        $('#channel-triggers').show();
        $('#channel-config-' + type).show();
        $('#notification_type').val(type);
    }

    // FIXME: This seems very wrong
    $('#notification button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var notification = app.Notifications.get($('#notification_id').val());

        notification.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#notification button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var notification_id = $('#notification_id').val();

        if (notification_id) {
            var notification = app.Notifications.get(notification_id);
        } else {
            var notification = new app.Notification();
        }

        var data = {
          config:                     null,
          name:                       $('#notification_name').val(),
          type:                       $('#notification_type').val(),
          project_id:                 parseInt($('input[name="project_id"]').val()),
          on_deployment_success:      $('#notification_on_deployment_success').is(':checked'),
          on_deployment_failure:      $('#notification_on_deployment_failure').is(':checked'),
          on_link_down:               $('#notification_on_link_down').is(':checked'),
          on_link_still_down:         $('#notification_on_link_still_down').is(':checked'),
          on_link_recovered:          $('#notification_on_link_recovered').is(':checked'),
          on_heartbeat_missing:       $('#notification_on_heartbeat_missing').is(':checked'),
          on_heartbeat_still_missing: $('#notification_on_heartbeat_still_missing').is(':checked'),
          on_heartbeat_recovered:     $('#notification_on_heartbeat_recovered').is(':checked')
        };

        $('#notification #channel-config-' + data.type + ' :input[id^=notification_config]').each(function(key, field) {
            var name = $(field).attr('name');

            data[name] = $(field).val();
        });

        notification.save(data, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!notification_id) {
                    app.Notifications.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.Notification = Backbone.Model.extend({
        urlRoot: '/notifications'
    });

    var Notifications = Backbone.Collection.extend({
        model: app.Notification
    });

    app.Notifications = new Notifications();

    app.NotificationsTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#notification_list tbody');

            $('#no_notifications').show();
            $('#notification_list').hide();

            this.listenTo(app.Notifications, 'add', this.addOne);
            this.listenTo(app.Notifications, 'reset', this.addAll);
            this.listenTo(app.Notifications, 'remove', this.addAll);
            this.listenTo(app.Notifications, 'all', this.render);


            app.listener.on('channel:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var notification = app.Notifications.get(parseInt(data.model.id));

                if (server) {
                    notification.set(data.model);
                }
            });

            app.listener.on('channel:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                if (parseInt(data.model.project_id) === parseInt(app.project_id)) {
                    app.Notifications.add(data.model);
                }
            });

            app.listener.on('channel:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var notification = app.Notifications.get(parseInt(data.model.id));

                if (notification) {
                    app.Notifications.remove(notification);
                }
            });
        },
        render: function () {
            if (app.Notifications.length) {
                $('#no_notifications').hide();
                $('#notification_list').show();
            } else {
                $('#no_notifications').show();
                $('#notification_list').hide();
            }
        },
        addOne: function (notification) {
            var view = new app.NotificationView({
                model: notification
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.Notifications.each(this.addOne, this);
        }
    });

    app.NotificationView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editNotification'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#notification-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            data.icon = 'cogs';
            data.label = Lang.get('channels.custom');

            if (this.model.get('type') !== 'custom') {
                data.label = Lang.get('channels.' + this.model.get('type'));
            }

            if (this.model.get('type') === 'slack') {
                data.icon = 'slack';
            } else if (this.model.get('type') === 'hipchat') {
                data.icon = 'comment-o fa-flip-horizontal';
            } else if (this.model.get('type') === 'mail') {
                data.icon = 'envelope-o';
            } else if (this.model.get('type') === 'twilio') {
                data.icon = 'mobile';
            }

            this.$el.html(this.template(data));

            return this;
        },
        editNotification: function() {
            var type = this.model.get('type');

            $.each(this.model.get('config'), function(field, value) {
                $('#channel-config-' + type + ' #notification_config_' + field).val(value);
            });

            // FIXME: Sure this is wrong?
            $('#notification_id').val(this.model.id);
            $('#notification_name').val(this.model.get('name'));
            $('#notification_type').val(type);
            $('#notification_on_deployment_success').prop('checked', (this.model.get('on_deployment_success') === true));
            $('#notification_on_deployment_failure').prop('checked', (this.model.get('on_deployment_failure') === true));
            $('#notification_on_link_down').prop('checked', (this.model.get('on_link_down') === true));
            $('#notification_on_link_still_down').prop('checked', (this.model.get('on_link_still_down') === true));
            $('#notification_on_link_recovered').prop('checked', (this.model.get('on_link_recovered') === true));
            $('#notification_on_heartbeat_missing').prop('checked', (this.model.get('on_heartbeat_missing') === true));
            $('#notification_on_heartbeat_still_missing').prop('checked', (this.model.get('on_heartbeat_still_missing') === true));
            $('#notification_on_heartbeat_recovered').prop('checked', (this.model.get('on_heartbeat_recovered') === true));

            setTitleWithIcon(this.model.get('type'), 'edit');
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
    // FIXME: This seems very wrong
    $('#sharefile').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('sharedFiles.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('sharedFiles.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#file_id').val('');
            $('#name').val('');
            $('#file').val('');
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#sharefile button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var file = app.SharedFiles.get($('#file_id').val());

        file.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#sharefile button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var file_id = $('#file_id').val();

        if (file_id) {
            var file = app.SharedFiles.get(file_id);
        } else {
            var file = new app.SharedFile();
        }

        file.save({
            name:        $('#name').val(),
            file:        $('#file').val(),
            target_type: $('input[name="target_type"]').val(),
            target_id:   parseInt($('input[name="target_id"]').val())
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!file_id) {
                    app.SharedFiles.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.SharedFile = Backbone.Model.extend({
        urlRoot: '/shared-files'
    });

    var SharedFiles = Backbone.Collection.extend({
        model: app.SharedFile
    });

    app.SharedFiles = new SharedFiles();

    app.SharedFilesTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#file_list tbody');

            $('#no_files').show();
            $('#file_list').hide();

            this.listenTo(app.SharedFiles, 'add', this.addOne);
            this.listenTo(app.SharedFiles, 'reset', this.addAll);
            this.listenTo(app.SharedFiles, 'remove', this.addAll);
            this.listenTo(app.SharedFiles, 'all', this.render);

            app.listener.on('sharedfile:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var share = app.SharedFiles.get(parseInt(data.model.id));

                if (share) {
                    share.set(data.model);
                }
            });

            app.listener.on('sharedfile:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                var target_type = $('input[name="target_type"]').val();
                var target_id = $('input[name="target_id"]').val();
                if (target_type == data.model.target_type && parseInt(data.model.target_id) === parseInt(target_id)) {
                    app.SharedFiles.add(data.model);
                }
            });


            app.listener.on('sharedfile:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var share = app.SharedFiles.get(parseInt(data.model.id));

                if (share) {
                    app.SharedFiles.remove(share);
                }
            });
        },
        render: function () {
            if (app.SharedFiles.length) {
                $('#no_files').hide();
                $('#file_list').show();
            } else {
                $('#no_files').show();
                $('#file_list').hide();
            }
        },
        addOne: function (file) {

            var view = new app.FileView({
                model: file
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.SharedFiles.each(this.addOne, this);
        }
    });

    app.FileView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editFile'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#files-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            this.$el.html(this.template(data));

            return this;
        },
        editFile: function() {
            // FIXME: Sure this is wrong?
            $('#file_id').val(this.model.id);
            $('#name').val(this.model.get('name'));
            $('#file').val(this.model.get('file'));
        }
    });

})(jQuery);

var app = app || {};

(function ($) {

    var editor;
    var previewfile;

    $('#configfile, #view-configfile').on('hidden.bs.modal', function (event) {
        editor.destroy();
    });

    $('#view-configfile').on('show.bs.modal', function (event) {
        editor = ace.edit('preview-content');
        editor.setReadOnly(true);
        editor.getSession().setUseWrapMode(true);

        var extension = previewfile.substr(previewfile.lastIndexOf('.') + 1).toLowerCase();

        if (extension === 'php' || extension === 'ini') {
            editor.getSession().setMode('ace/mode/' + extension);
        } else if (extension === 'yml') {
            editor.getSession().setMode('ace/mode/yaml');
        }
    });

    // FIXME: This seems very wrong
    $('#configfile').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('configFiles.create');

        editor = ace.edit('config-file-content');

        var filename = $('#config-file-path').val();
        var extension = filename.substr(filename.lastIndexOf('.') + 1).toLowerCase();

        if (extension === 'php' || extension === 'ini') {
            editor.getSession().setMode('ace/mode/' + extension);
        } else if (extension === 'yml') {
            editor.getSession().setMode('ace/mode/yaml');
        }

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('configFiles.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#config_file_id').val('');
            $('#config-file-name').val('');
            $('#config-file-path').val('');
            editor.setValue('');
            editor.gotoLine(1);
        }

        modal.find('.modal-title span').text(title);
    });


    // FIXME: This seems very wrong
    $('#configfile button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var file = app.ConfigFiles.get($('#config_file_id').val());

        file.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#configfile button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var config_file_id = $('#config_file_id').val();

        if (config_file_id) {
            var file = app.ConfigFiles.get(config_file_id);
        } else {
            var file = new app.ConfigFile();
        }

        file.save({
            name:        $('#config-file-name').val(),
            path:        $('#config-file-path').val(),
            content:     editor.getValue(),
            target_type: $('input[name="target_type"]').val(),
            target_id:   parseInt($('input[name="target_id"]').val())
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!config_file_id) {
                    app.ConfigFiles.add(response);
                }

                editor.setValue('');
                editor.gotoLine(1);
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.ConfigFile = Backbone.Model.extend({
        urlRoot: '/config-file'
    });

    var ConfigFiles = Backbone.Collection.extend({
        model: app.ConfigFile
    });

    app.ConfigFiles = new ConfigFiles();

    app.ConfigFilesTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#configfile_list tbody');

            $('#no_configfiles').show();
            $('#configfile_list').hide();

            this.listenTo(app.ConfigFiles, 'add', this.addOne);
            this.listenTo(app.ConfigFiles, 'reset', this.addAll);
            this.listenTo(app.ConfigFiles, 'remove', this.addAll);
            this.listenTo(app.ConfigFiles, 'all', this.render);

            app.listener.on('configfile:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var file = app.ConfigFiles.get(parseInt(data.model.id));

                if (file) {
                    file.set(data.model);
                }
            });

            app.listener.on('configfile:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                var target_type = $('input[name="target_type"]').val();
                var target_id = $('input[name="target_id"]').val();
                if (target_type == data.model.target_type && parseInt(data.model.target_id) === parseInt(target_id)) {
                    app.ConfigFiles.add(data.model);
                }
            });

            app.listener.on('configfile:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var file = app.ConfigFiles.get(parseInt(data.model.id));

                if (file) {
                    app.ConfigFiles.remove(file);
                }
            });
        },
        render: function () {
            if (app.ConfigFiles.length) {
                $('#no_configfiles').hide();
                $('#configfile_list').show();
            } else {
                $('#no_configfiles').show();
                $('#configfile_list').hide();
            }
        },
        addOne: function (file) {

            var view = new app.ConfigFileView({
                model: file
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.ConfigFiles.each(this.addOne, this);
        }
    });

    app.ConfigFileView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editFile',
            'click .btn-view': 'viewFile'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#config-files-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            this.$el.html(this.template(data));

            return this;
        },
        viewFile: function() {
            previewfile = this.model.get('path');
            $('#preview-content').text(this.model.get('content'));
        },
        editFile: function() {
            // FIXME: Sure this is wrong?
            $('#config_file_id').val(this.model.id);
            $('#config-file-name').val(this.model.get('name'));
            $('#config-file-path').val(this.model.get('path'));
            $('#config-file-content').text(this.model.get('content'));
        }
    });

})(jQuery);

var app = app || {};

(function ($) {
    var ONLINE   = 0;
    var UNTESTED = 1;
    var OFFLINE  = 2;

    $('#checkurl').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('checkUrls.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('checkUrls.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#url_id').val('');
            $('#url_name').val('');
            $('#url_url').val('');
            $('#period_5').prop('checked', true);
        }

        modal.find('.modal-title span').text(title);
    });

    $('#checkurl button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var url = app.CheckUrls.get($('#url_id').val());

        url.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    $('#checkurl button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var url_id = $('#url_id').val();

        if (url_id) {
            var url = app.CheckUrls.get(url_id);
        } else {
            var url = new app.CheckUrl();
        }

        url.save({
            name:       $('#url_name').val(),
            url:        $('#url_url').val(),
            period:     parseInt($('input[name=period]:checked').val()),
            project_id: parseInt($('input[name="project_id"]').val())
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!url_id) {
                    app.CheckUrls.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.CheckUrl = Backbone.Model.extend({
        urlRoot: '/check-url'
    });

    var CheckUrls = Backbone.Collection.extend({
        model: app.CheckUrl
    });

    app.CheckUrls = new CheckUrls();

    app.CheckUrlsTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#checkurl_list tbody');

            $('#no_checkurls').show();
            $('#checkurl_list').hide();

            this.listenTo(app.CheckUrls, 'add', this.addOne);
            this.listenTo(app.CheckUrls, 'reset', this.addAll);
            this.listenTo(app.CheckUrls, 'remove', this.addAll);
            this.listenTo(app.CheckUrls, 'all', this.render);

            app.listener.on('checkurl:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var link = app.CheckUrls.get(parseInt(data.model.id));

                if (link) {
                    link.set(data.model);
                }
            });

            app.listener.on('checkurl:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                if (parseInt(data.model.project_id) === parseInt(app.project_id)) {
                    app.CheckUrls.add(data.model);
                }
            });

            app.listener.on('checkurl:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var link = app.CheckUrls.get(parseInt(data.model.id));

                if (link) {
                    app.CheckUrls.remove(link);
                }
            });
        },
        render: function () {
            if (app.CheckUrls.length) {
                $('#no_checkurls').hide();
                $('#checkurl_list').show();
            } else {
                $('#no_checkurls').show();
                $('#checkurl_list').hide();
            }
        },
        addOne: function (url) {
            var view = new app.CheckUrlView({
                model: url
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.CheckUrls.each(this.addOne, this);
        }
    });

    app.CheckUrlView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editUrl',
            'click .btn-view': 'viewLog'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#checkUrls-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            data.status_css = 'primary';
            data.icon_css   = 'question';
            data.status     = Lang.get('checkUrls.untested');
            data.has_run    = false;
            data.has_log    = false;

            if (parseInt(this.model.get('status')) === OFFLINE) {
                data.status_css = 'danger';
                data.icon_css   = 'warning';
                data.status     = Lang.get('checkUrls.failed');
                data.has_run    = data.last_seen ? true : false;
                data.has_log    = data.last_log ? true : false;
            } else if (parseInt(this.model.get('status')) === ONLINE) {
                data.status_css = 'success';
                data.icon_css   = 'check';
                data.status     = Lang.get('checkUrls.successful');
                data.has_run    = true;
            }

            data.formatted_date = '';
            if (data.has_run) {
                data.formatted_date = moment(data.last_seen).format('Do MMMM YYYY h:mm:ss A');
            }

            data.interval_label = data.period + ' ' + Lang.get('checkUrls.length');

            this.$el.html(this.template(data));

            return this;
        },
        viewLog: function() {
            var modal = $('div.modal#result');
            var title = Lang.get('checkUrls.log_title');

            modal.find('pre').text(this.model.get('last_log'));
            modal.find('.modal-title span').text(title);
        },
        editUrl: function() {
            $('#url_id').val(this.model.id);
            $('#url_name').val(this.model.get('name'));
            $('#url_url').val(this.model.get('url'));
            $('#period_' + this.model.get('period')).prop('checked', true);
        }
    });

})(jQuery);

var app = app || {};

(function ($) {
   // FIXME: This seems very wrong
    $('#variable').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('variables.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('variables.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#variable_id').val('');
            $('#variable_name').val('');
            $('#variable_value').val('');
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#variable button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var variable = app.Variables.get($('#variable_id').val());

        variable.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#variable button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var variable_id = $('#variable_id').val();

        if (variable_id) {
            var variable = app.Variables.get(variable_id);
        } else {
            var variable = new app.Variable();
        }

        variable.save({
            name:        $('#variable_name').val(),
            value:       $('#variable_value').val(),
            target_type: $('input[name="target_type"]').val(),
            target_id:   parseInt($('input[name="target_id"]').val())
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!variable_id) {
                    app.Variables.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.Variable = Backbone.Model.extend({
        urlRoot: '/variables',
        initialize: function() {

        }
    });

    var Variables = Backbone.Collection.extend({
        model: app.Variable
    });

    app.Variables = new Variables();

    app.VariablesTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#variable_list tbody');

            $('#variable_list').hide();

            this.listenTo(app.Variables, 'add', this.addOne);
            this.listenTo(app.Variables, 'reset', this.addAll);
            this.listenTo(app.Variables, 'remove', this.addAll);
            this.listenTo(app.Variables, 'all', this.render);

            app.listener.on('variable:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                $('#variable_' + data.model.id).html(data.model.name);

                var variable = app.Variables.get(parseInt(data.model.id));

                if (variable) {
                    variable.set(data.model);
                }
            });

            app.listener.on('variable:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                var target_type = $('input[name="target_type"]').val();
                var target_id = $('input[name="target_id"]').val();
                if (target_type == data.model.target_type && parseInt(data.model.target_id) === parseInt(target_id)) {
                    app.Variables.add(data.model);
                }
            });

            app.listener.on('variable:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var variable = app.Variables.get(parseInt(data.model.id));

                if (variable) {
                    app.Variables.remove(variable);
                }
            });
        },
        render: function () {
            if (app.Variables.length) {
                $('#variable_list').show();
            } else {
                $('#variable_list').hide();
            }
        },
        addOne: function (variable) {

            var view = new app.VariableView({
                model: variable
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.Variables.each(this.addOne, this);
        }
    });

    app.VariableView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editVariable'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#variable-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            this.$el.html(this.template(data));

            return this;
        },
        editVariable: function() {
            $('#variable_id').val(this.model.id);
            $('#variable_name').val(this.model.get('name'));
            $('#variable_value').val(this.model.get('value'));
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
    var COMPLETED = 0;
    var PENDING   = 1;
    var RUNNING   = 2;
    var FAILED    = 3;
    var CANCELLED = 4;

    $('#redeploy').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget);
        var deployment = button.data('deployment-id');

        var tmp = button.data('optional-commands') + '';
        var commands = tmp.split(',');

        if (tmp.length > 0) {
            commands = $.map(commands, function(value) {
                return parseInt(value, 10);
            });
        } else {
            commands = [];
        }

        var modal = $(this);

        $('form', modal).prop('action', '/deployment/' + deployment + '/rollback');

        $('input:checkbox', modal).each(function (index, element) {
            var input = $(element);

            input.prop('checked', false);
            if ($.inArray(parseInt(input.val(), 10), commands) != -1) {
                input.prop('checked', true);
            }
        });
    });

    $('.btn-cancel').on('click', function (event) {
        var button = $(event.currentTarget);
        var deployment = button.data('deployment-id');

        $('form#abort_' + deployment).trigger('submit');
    });

    var fetchingLog = false;
    $('#log').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var log_id = button.attr('id').replace('log_', '');

        var step = $('h3 span', button.parents('.box')).text();
        var modal = $(this);
        var log = $('pre', modal);
        var loader = $('#loading', modal);

        log.hide();
        loader.show();

        $('#action', modal).text(step);
        log.text('');

        fetchingLog = true;

        $.ajax({
            type: 'GET',
            url: '/log/' + log_id
        }).done(function (data) {
            var output = parseOutput(data.output ? data.output : '');

            log.html(output);

            log.show();
            loader.hide();

            app.listener.on('serverlog-' + log_id + ':REBELinBLUE\\Deployer\\Events\\ServerOutputChanged', function (data) {
                if (data.log_id === parseInt(log_id)) {
                  fetchLog(log, data.log_id);
                }
            });
        }).always(function() {
            fetchingLog = false;
        });
    });

    $('#log').on('hide.bs.modal', function () {
        fetchingLog = false;
    });

    function fetchLog(element, log_id) {
        if (fetchingLog) {
            return;
        }

        fetchingLog = true;

        $.ajax({
            type: 'GET',
            url: '/log/' + log_id
        }).done(function (data) {
            var output = parseOutput(data.output ? data.output : '');
            var atBottom = false;

            if (element.scrollTop() + element.innerHeight() >= element.get(0).scrollHeight) {
                atBottom = true;
            }

            element.html(output);

            if (atBottom) {
                element.scrollTop(element.get(0).scrollHeight);
            }
        }).always(function() {
            fetchingLog = false;
        });
    }

    app.ServerLog = Backbone.Model.extend({
        urlRoot: '/status'
    });

    var Deployment = Backbone.Collection.extend({
        model: app.ServerLog
    });

    app.Deployment = new Deployment();

    app.DeploymentView = Backbone.View.extend({
        el: '#app',
        $containers: [],
        events: {

        },
        initialize: function() {
            var that = this;
            $('.deploy-step tbody').each(function(index, element) {
                that.$containers.push({
                    step: parseInt($(element).attr('id').replace('step_', '')),
                    element: element
                })
            });

            this.listenTo(app.Deployment, 'add', this.addOne);
            this.listenTo(app.Deployment, 'reset', this.addAll);
            this.listenTo(app.Deployment, 'remove', this.addAll);
            this.listenTo(app.Deployment, 'all', this.render);

            app.listener.on('serverlog:REBELinBLUE\\Deployer\\Events\\ServerLogChanged', function (data) {
                var deployment = app.Deployment.get(data.log_id);

                if (deployment) {
                    deployment.set({
                        status: data.status,
                        output: data.output,
                        runtime: data.runtime,
                        started_at: data.started_at ? data.started_at : false,
                        finished_at: data.finished_at ? data.finished_at : false
                    });

                    // FIXME: If cancelled update all other deployments straight away
                    // FIXME: If completed fake making the next model "running" so it looks responsive
                }
            });

            app.listener.on('deployment:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                if (parseInt(data.model.project_id) === parseInt(app.project_id)) {
                    if (data.model.repo_failure) {
                        $('#repository_error').show();
                    }
                }
            });

        },
        addOne: function (step) {
            var view = new app.LogView({
                model: step
            });

            var found = _.find(this.$containers, function(element) {
                return parseInt(element.step) === parseInt(step.get('deploy_step_id'));
            });

            $(found.element).append(view.render().el);

        },
        addAll: function () {
            $(this.$containers).each(function (index, element) {
                element.html('');
            });

            app.Commands.each(this.addOne, this);
        }
    });

    app.LogView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            //'click .btn-log': 'showLog',
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#log-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            data.status_css = 'info';
            data.icon_css = 'clock-o';
            data.status = Lang.get('deployments.pending');

            if (parseInt(this.model.get('status')) === COMPLETED) {
                data.status_css = 'success';
                data.icon_css = 'check';
                data.status = Lang.get('deployments.completed');
            } else if (parseInt(this.model.get('status')) === RUNNING) {
                data.status_css = 'warning';
                data.icon_css = 'spinner fa-spin';
                data.status = Lang.get('deployments.running');
            } else if (parseInt(this.model.get('status')) === FAILED || parseInt(this.model.get('status')) === CANCELLED) {
                data.status_css = 'danger';
                data.icon_css = 'warning';

                data.status = Lang.get('deployments.failed');
                if (parseInt(this.model.get('status')) === CANCELLED) {
                    data.status = Lang.get('deployments.cancelled');
                }
            }

            data.formatted_start_time = data.started_at ? moment(data.started_at).format('h:mm:ss A') : false;
            data.formatted_end_time   = data.finished_at ? moment(data.finished_at).format('h:mm:ss A') : false;

            this.$el.html(this.template(data));

            return this;
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
    $('.command-list table').sortable({
        containerSelector: 'table',
        itemPath: '> tbody',
        itemSelector: 'tr',
        placeholder: '<tr class="placeholder"/>',
        delay: 500,
        onDrop: function (item, container, _super) {
            _super(item, container);

            var ids = [];
            $('tbody tr td:first-child', container.el[0]).each(function (idx, element) {
                ids.push($(element).data('command-id'));
            });

            $.ajax({
                url: '/commands/reorder',
                method: 'POST',
                data: {
                    commands: ids
                }
            });
        }
    });

    var editor;

    $('#command').on('hidden.bs.modal', function (event) {
        editor.destroy();
    });

    // FIXME: This seems very wrong
    $('#command').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('commands.create');

        editor = ace.edit('command_script');
        editor.getSession().setMode('ace/mode/sh');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('commands.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#command_id').val('');
            $('#command_step').val(button.data('step'));
            $('#command_name').val('');
            editor.setValue('');
            editor.gotoLine(1);
            $('#command_user').val('');
            $('#command_optional').prop('checked', false);
            $('#command_default_on').prop('checked', false);
            $('#command_default_on_row').addClass('hide');

            $('.command-server').prop('checked', true);
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#command button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var command = app.Commands.get($('#command_id').val());

        command.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    $('#command_optional').on('change', function (event) {
        $('#command_default_on_row').addClass('hide');
        if ($(this).is(':checked') === true) {
            $('#command_default_on_row').removeClass('hide');
        }
    });

    // FIXME: This seems very wrong
    $('#command button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find(':input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var command_id = $('#command_id').val();

        if (command_id) {
            var command = app.Commands.get(command_id);
        } else {
            var command = new app.Command();
        }

        var server_ids = [];

        $('.command-server:checked').each(function() {
            server_ids.push($(this).val());
        });

        command.save({
            name:        $('#command_name').val(),
            script:      editor.getValue(),
            user:        $('#command_user').val(),
            step:        $('#command_step').val(),
            target_type: $('input[name="target_type"]').val(),
            target_id:   parseInt($('input[name="target_id"]').val()),
            servers:     server_ids,
            optional:    $('#command_optional').is(':checked'),
            default_on:  $('#command_default_on').is(':checked')
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find(':input').removeAttr('disabled');

                if (!command_id) {
                    app.Commands.add(response);
                }

                editor.setValue('');
                editor.gotoLine(1);
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find(':input').removeAttr('disabled');
            }
        });
    });

    app.Command = Backbone.Model.extend({
        urlRoot: '/commands',
        defaults: function() {
            return {
                order: app.Commands.nextOrder()
            };
        },
        isAfter: function() {
            return (parseInt(this.get('step')) % 3 === 0);
        }
    });

    var Commands = Backbone.Collection.extend({
        model: app.Command,
        comparator: 'order',
        nextOrder: function() {
            if (!this.length) {
                return 1;
            }

            return this.last().get('order') + 1;
        }
    });

    app.Commands = new Commands();

    app.CommandsTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$beforeList = $('#commands-before .command-list tbody');
            this.$afterList = $('#commands-after .command-list tbody');

            $('.no-commands').show();
            $('.command-list').hide();

            this.listenTo(app.Commands, 'add', this.addOne);
            this.listenTo(app.Commands, 'reset', this.addAll);
            this.listenTo(app.Commands, 'remove', this.addAll);
            this.listenTo(app.Commands, 'all', this.render);

            // FIXME: Need to regenerate the order!

            app.listener.on('command:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var command = app.Commands.get(parseInt(data.model.id));

                if (command) {
                    command.set(data.model);
                }
            });

            app.listener.on('command:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                var target_type = $('input[name="target_type"]').val();
                var target_id = $('input[name="target_id"]').val();
                if (target_type == data.model.target_type && parseInt(data.model.target_id) === parseInt(target_id)) {
                    // Make sure the command is for this action (clone, install, activate, purge)
                    if (parseInt(data.model.step) + 1 === parseInt(app.command_action) || parseInt(data.model.step) - 1 === parseInt(app.command_action)) {
                        app.Commands.add(data.model);
                    }
                }
            });

            app.listener.on('command:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var command = app.Commands.get(parseInt(data.model.id));

                if (command) {
                    app.Commands.remove(command);
                }
            });
        },
        render: function () {
            var before = app.Commands.find(function(model) {
                return !model.isAfter();
            });

            if (typeof before !== 'undefined') {
                $('#commands-before .no-commands').hide();
                $('#commands-before .command-list').show();
            } else {
                $('#commands-before .no-commands').show();
                $('#commands-before .command-list').hide();
            }

            var after = app.Commands.find(function(model) {
                return model.isAfter();
            });

            if (typeof after !== 'undefined') {
                $('#commands-after .no-commands').hide();
                $('#commands-after .command-list').show();
            } else {
                $('#commands-after .no-commands').show();
                $('#commands-after .command-list').hide();
            }
        },
        addOne: function (command) {
            var view = new app.CommandView({
                model: command
            });

            if (command.isAfter()) {
                this.$afterList.append(view.render().el);
            } else {
                this.$beforeList.append(view.render().el);
            }
        },
        addAll: function () {
            this.$beforeList.html('');
            this.$afterList.html('');
            app.Commands.each(this.addOne, this);
        }
    });

    app.CommandView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editCommand'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#command-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            this.$el.html(this.template(data));

            return this;
        },
        editCommand: function() {
            // FIXME: Sure this is wrong?
            $('#command_id').val(this.model.id);
            $('#command_step').val(this.model.get('step'));
            $('#command_name').val(this.model.get('name'));
            $('#command_script').text(this.model.get('script'));
            $('#command_user').val(this.model.get('user'));
            $('#command_optional').prop('checked', (this.model.get('optional') === true));
            $('#command_default_on').prop('checked', (this.model.get('default_on') === true));

            $('#command_default_on_row').addClass('hide');
            if (this.model.get('optional') === true) {
                $('#command_default_on_row').removeClass('hide');
            }

            $('.command-server').prop('checked', false);
            $(this.model.get('servers')).each(function (index, server) {
                $('#command_server_' + server.id).prop('checked', true);
            });
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
   // FIXME: This seems very wrong
    $('#user').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('users.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.existing-only', modal).hide();
        $('.new-only', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('users.edit');
            $('.btn-danger', modal).show();
            $('.existing-only', modal).show();
        } else {
            $('#user_id').val('');
            $('#user_name').val('');
            $('#user_email').val('');
            $('#user_password').val('');
            $('#user_password_confirmation').val('');

            $('.new-only', modal).show();
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#user button.btn-delete').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-trash');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var user = app.Users.get($('#user_id').val());

        user.destroy({
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            },
            error: function() {
                icon.removeClass('fa-refresh fa-spin').addClass('fa-trash');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    // FIXME: This seems very wrong
    $('#user button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var user_id = $('#user_id').val();

        if (user_id) {
            var user = app.Users.get(user_id);
        } else {
            var user = new app.User();
        }

        user.save({
            name:                  $('#user_name').val(),
            email:                 $('#user_email').val(),
            password:              $('#user_password').val(),
            password_confirmation: $('#user_password_confirmation').val()
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!user_id) {
                    app.Users.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.User = Backbone.Model.extend({
        urlRoot: '/admin/users',
        initialize: function() {

        }
    });

    var Users = Backbone.Collection.extend({
        model: app.User
    });

    app.Users = new Users();

    app.UsersTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#user_list tbody');

            this.listenTo(app.Users, 'add', this.addOne);
            this.listenTo(app.Users, 'reset', this.addAll);
            this.listenTo(app.Users, 'remove', this.addAll);
            this.listenTo(app.Users, 'all', this.render);

            app.listener.on('user:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                var user = app.Users.get(parseInt(data.model.id));

                if (user) {
                    user.set(data.model);
                }
            });

            app.listener.on('user:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                app.Users.add(data.model);
            });

            app.listener.on('user:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var user = app.Users.get(parseInt(data.model.id));

                if (user) {
                    app.Users.remove(user);
                }
            });
        },
        addOne: function (user) {
            var view = new app.UserView({
                model: user
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.Users.each(this.addOne, this);
        }
    });

    app.UserView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editUser'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#user-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            data.created = moment(data.created_at).format('Do MMMM YYYY h:mm:ss A');

            this.$el.html(this.template(data));

            return this;
        },
        editUser: function() {
            $('#user_id').val(this.model.id);
            $('#user_name').val(this.model.get('name'));
            $('#user_email').val(this.model.get('email'));
        }
    });
})(jQuery);

var app = app || {};

(function ($) {
    $('#group_list table').sortable({
        containerSelector: 'table',
        itemPath: '> tbody',
        itemSelector: 'tr',
        placeholder: '<tr class="placeholder"/>',
        delay: 500,
        onDrop: function (item, container, _super) {
            _super(item, container);

            var ids = [];
            $('tbody tr td:first-child', container.el[0]).each(function (idx, element) {
                ids.push($(element).data('group-id'));
            });

            $.ajax({
                url: '/admin/groups/reorder',
                method: 'POST',
                data: {
                    groups: ids
                }
            });
        }
    });

   // FIXME: This seems very wrong
    $('#group').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = Lang.get('groups.create');

        $('.btn-danger', modal).hide();
        $('.callout-danger', modal).hide();
        $('.has-error', modal).removeClass('has-error');
        $('.label-danger', modal).remove();

        if (button.hasClass('btn-edit')) {
            title = Lang.get('groups.edit');
            $('.btn-danger', modal).show();
        } else {
            $('#group_id').val('');
            $('#group_name').val('');
        }

        modal.find('.modal-title span').text(title);
    });

    // FIXME: This seems very wrong
    $('#group button.btn-save').on('click', function (event) {
        var target = $(event.currentTarget);
        var icon = target.find('i');
        var dialog = target.parents('.modal');

        icon.addClass('fa-refresh fa-spin').removeClass('fa-save');
        dialog.find('input').attr('disabled', 'disabled');
        $('button.close', dialog).hide();

        var group_id = $('#group_id').val();

        if (group_id) {
            var group = app.Groups.get(group_id);
        } else {
            var group = new app.Group();
        }

        group.save({
            name: $('#group_name').val()
        }, {
            wait: true,
            success: function(model, response, options) {
                dialog.modal('hide');
                $('.callout-danger', dialog).hide();

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');

                if (!group_id) {
                    app.Groups.add(response);
                }
            },
            error: function(model, response, options) {
                $('.callout-danger', dialog).show();

                var errors = response.responseJSON;

                $('.has-error', dialog).removeClass('has-error');
                $('.label-danger', dialog).remove();

                $('form input', dialog).each(function (index, element) {
                    element = $(element);

                    var name = element.attr('name');

                    if (typeof errors[name] !== 'undefined') {
                        var parent = element.parents('div.form-group');
                        parent.addClass('has-error');
                        parent.append($('<span>').attr('class', 'label label-danger').text(errors[name]));
                    }
                });

                icon.removeClass('fa-refresh fa-spin').addClass('fa-save');
                $('button.close', dialog).show();
                dialog.find('input').removeAttr('disabled');
            }
        });
    });

    app.Group = Backbone.Model.extend({
        urlRoot: '/admin/groups',
        initialize: function() {

        }
    });

    var Groups = Backbone.Collection.extend({
        model: app.Group
    });

    app.Groups = new Groups();

    app.GroupsTab = Backbone.View.extend({
        el: '#app',
        events: {

        },
        initialize: function() {
            this.$list = $('#group_list tbody');

            this.listenTo(app.Groups, 'add', this.addOne);
            this.listenTo(app.Groups, 'reset', this.addAll);
            this.listenTo(app.Groups, 'remove', this.addAll);
            this.listenTo(app.Groups, 'all', this.render);

            app.listener.on('group:REBELinBLUE\\Deployer\\Events\\ModelChanged', function (data) {
                $('#group_' + data.model.id).html(data.model.name);

                var group = app.Groups.get(parseInt(data.model.id));

                if (group) {
                    group.set(data.model);
                }
            });

            app.listener.on('group:REBELinBLUE\\Deployer\\Events\\ModelCreated', function (data) {
                app.Groups.add(data.model);

                // Append to the menu
                if ($('#sidebar_group_' + data.model.id).length === 0) {
                    var template = _.template($('#group-sidebar-template').html());
                    $(template(data.model)).insertBefore($('.sidebar-menu li.treeview').last());
                }
            });

            app.listener.on('group:REBELinBLUE\\Deployer\\Events\\ModelTrashed', function (data) {
                var group = app.Groups.get(parseInt(data.model.id));

                if (group) {
                    app.Groups.remove(group);
                }
            });
        },
        addOne: function (group) {

            var view = new app.GroupView({
                model: group
            });

            this.$list.append(view.render().el);
        },
        addAll: function () {
            this.$list.html('');
            app.Servers.each(this.addOne, this);
        }
    });

    app.GroupView = Backbone.View.extend({
        tagName:  'tr',
        events: {
            'click .btn-edit': 'editGroup'
        },
        initialize: function () {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

            this.template = _.template($('#group-template').html());
        },
        render: function () {
            var data = this.model.toJSON();

            this.$el.html(this.template(data));

            return this;
        },
        editGroup: function() {
            $('#group_id').val(this.model.id);
            $('#group_name').val(this.model.get('name'));
        }
    });
})(jQuery);

var iframeCount = 0;

function Uploader(options) {
  if (!(this instanceof Uploader)) {
    return new Uploader(options);
  }
  if (isString(options)) {
    options = {trigger: options};
  }

  var settings = {
    trigger: null,
    name: null,
    action: null,
    data: null,
    accept: null,
    change: null,
    error: null,
    multiple: true,
    success: null
  };
  if (options) {
    $.extend(settings, options);
  }
  var $trigger = $(settings.trigger);

  settings.action = settings.action || $trigger.data('action') || '/upload';
  settings.name = settings.name || $trigger.attr('name') || $trigger.data('name') || 'file';
  settings.data = settings.data || parse($trigger.data('data'));
  settings.accept = settings.accept || $trigger.data('accept');
  settings.success = settings.success || $trigger.data('success');
  this.settings = settings;

  this.setup();
  this.bind();
}

// initialize
// create input, form, iframe
Uploader.prototype.setup = function() {
  this.form = $(
    '<form method="post" enctype="multipart/form-data"'
    + 'target="" action="' + this.settings.action + '" />'
  );

  this.iframe = newIframe();
  this.form.attr('target', this.iframe.attr('name'));

  var data = this.settings.data;
  this.form.append(createInputs(data));
  if (window.FormData) {
    this.form.append(createInputs({'_uploader_': 'formdata'}));
  } else {
    this.form.append(createInputs({'_uploader_': 'iframe'}));
  }

  var input = document.createElement('input');
  input.type = 'file';
  input.name = this.settings.name;
  if (this.settings.accept) {
    input.accept = this.settings.accept;
  }
  if (this.settings.multiple) {
    input.multiple = true;
    input.setAttribute('multiple', 'multiple');
  }
  this.input = $(input);

  var $trigger = $(this.settings.trigger);
  this.input.attr('hidefocus', true).css({
    position: 'absolute',
    top: 0,
    right: 0,
    opacity: 0,
    outline: 0,
    cursor: 'pointer',
    height: $trigger.outerHeight(),
    fontSize: Math.max(64, $trigger.outerHeight() * 5)
  });
  this.form.append(this.input);
  this.form.css({
    position: 'absolute',
    top: $trigger.offset().top,
    left: $trigger.offset().left,
    overflow: 'hidden',
    width: $trigger.outerWidth(),
    height: $trigger.outerHeight(),
    zIndex: findzIndex($trigger) + 10
  }).appendTo('body');
  return this;
};

// bind events
Uploader.prototype.bind = function() {
  var self = this;
  var $trigger = $(self.settings.trigger);
  $trigger.mouseenter(function() {
    self.form.css({
      top: $trigger.offset().top,
      left: $trigger.offset().left,
      width: $trigger.outerWidth(),
      height: $trigger.outerHeight()
    });
  });
  self.bindInput();
};

Uploader.prototype.bindInput = function() {
  var self = this;
  self.input.change(function(e) {
    // ie9 don't support FileList Object
    // http://stackoverflow.com/questions/12830058/ie8-input-type-file-get-files
    self._files = this.files || [{
      name: e.target.value
    }];
    var file = self.input.val();
    if (self.settings.change) {
      self.settings.change.call(self, self._files);
    } else if (file) {
      return self.submit();
    }
  });
};

// handle submit event
// prepare for submiting form
Uploader.prototype.submit = function() {
  var self = this;
  if (window.FormData && self._files) {
    // build a FormData
    var form = new FormData(self.form.get(0));
    // use FormData to upload
    form.append(self.settings.name, self._files);

    var optionXhr;
    if (self.settings.progress) {
      // fix the progress target file
      var files = self._files;
      optionXhr = function() {
        var xhr = $.ajaxSettings.xhr();
        if (xhr.upload) {
          xhr.upload.addEventListener('progress', function(event) {
            var percent = 0;
            var position = event.loaded || event.position; /*event.position is deprecated*/
            var total = event.total;
            if (event.lengthComputable) {
                percent = Math.ceil(position / total * 100);
            }
            self.settings.progress(event, position, total, percent, files);
          }, false);
        }
        return xhr;
      };
    }
    $.ajax({
      url: self.settings.action,
      type: 'post',
      processData: false,
      contentType: false,
      data: form,
      xhr: optionXhr,
      context: this,
      success: self.settings.success,
      error: self.settings.error
    });
    return this;
  } else {
    // iframe upload
    self.iframe = newIframe();
    self.form.attr('target', self.iframe.attr('name'));
    $('body').append(self.iframe);
    self.iframe.one('load', function() {
      // https://github.com/blueimp/jQuery-File-Upload/blob/9.5.6/js/jquery.iframe-transport.js#L102
      // Fix for IE endless progress bar activity bug
      // (happens on form submits to iframe targets):
      $('<iframe src="javascript:false;"></iframe>')
        .appendTo(self.form)
        .remove();
      var response;
      try {
        response = $(this).contents().find("body").html();
      } catch (e) {
        response = "cross-domain";
      }
      $(this).remove();
      if (!response) {
        if (self.settings.error) {
          self.settings.error(self.input.val());
        }
      } else {
        if (self.settings.success) {
          self.settings.success(response);
        }
      }
    });
    self.form.submit();
  }
  return this;
};

Uploader.prototype.refreshInput = function() {
  //replace the input element, or the same file can not to be uploaded
  var newInput = this.input.clone();
  this.input.before(newInput);
  this.input.off('change');
  this.input.remove();
  this.input = newInput;
  this.bindInput();
};

// handle change event
// when value in file input changed
Uploader.prototype.change = function(callback) {
  if (!callback) {
    return this;
  }
  this.settings.change = callback;
  return this;
};

// handle when upload success
Uploader.prototype.success = function(callback) {
  var me = this;
  this.settings.success = function(response) {
    me.refreshInput();
    if (callback) {
      callback(response);
    }
  };

  return this;
};

// handle when upload success
Uploader.prototype.error = function(callback) {
  var me = this;
  this.settings.error = function(response) {
    if (callback) {
      me.refreshInput();
      callback(response);
    }
  };
  return this;
};

// enable
Uploader.prototype.enable = function(){
  this.input.prop('disabled', false);
  this.input.css('cursor', 'pointer');
};

// disable
Uploader.prototype.disable = function(){
  this.input.prop('disabled', true);
  this.input.css('cursor', 'not-allowed');
};

// Helpers
// -------------

function isString(val) {
  return Object.prototype.toString.call(val) === '[object String]';
}

function createInputs(data) {
  if (!data) return [];

  var inputs = [], i;
  for (var name in data) {
    i = document.createElement('input');
    i.type = 'hidden';
    i.name = name;
    i.value = data[name];
    inputs.push(i);
  }
  return inputs;
}

function parse(str) {
  if (!str) return {};
  var ret = {};

  var pairs = str.split('&');
  var unescape = function(s) {
    return decodeURIComponent(s.replace(/\+/g, ' '));
  };

  for (var i = 0; i < pairs.length; i++) {
    var pair = pairs[i].split('=');
    var key = unescape(pair[0]);
    var val = unescape(pair[1]);
    ret[key] = val;
  }

  return ret;
}

function findzIndex($node) {
  var parents = $node.parentsUntil('body');
  var zIndex = 0;
  for (var i = 0; i < parents.length; i++) {
    var item = parents.eq(i);
    if (item.css('position') !== 'static') {
      zIndex = parseInt(item.css('zIndex'), 10) || zIndex;
    }
  }
  return zIndex;
}

function newIframe() {
  var iframeName = 'iframe-uploader-' + iframeCount;
  var iframe = $('<iframe name="' + iframeName + '" />').hide();
  iframeCount += 1;
  return iframe;
}

function MultipleUploader(options) {
  if (!(this instanceof MultipleUploader)) {
    return new MultipleUploader(options);
  }

  if (isString(options)) {
    options = {trigger: options};
  }
  var $trigger = $(options.trigger);

  var uploaders = [];
  $trigger.each(function(i, item) {
    options.trigger = item;
    uploaders.push(new Uploader(options));
  });
  this._uploaders = uploaders;
}
MultipleUploader.prototype.submit = function() {
  $.each(this._uploaders, function(i, item) {
    item.submit();
  });
  return this;
};
MultipleUploader.prototype.change = function(callback) {
  $.each(this._uploaders, function(i, item) {
    item.change(callback);
  });
  return this;
};
MultipleUploader.prototype.success = function(callback) {
  $.each(this._uploaders, function(i, item) {
    item.success(callback);
  });
  return this;
};
MultipleUploader.prototype.error = function(callback) {
  $.each(this._uploaders, function(i, item) {
    item.error(callback);
  });
  return this;
};
MultipleUploader.prototype.enable = function (){
  $.each(this._uploaders, function (i, item){
    item.enable();
  });
  return this;
};
MultipleUploader.prototype.disable = function (){
  $.each(this._uploaders, function (i, item){
    item.disable();
  });
  return this;
};
MultipleUploader.Uploader = Uploader;
var app = app || {};

(function ($) {
    // Stop the uploader causing errors on pages it shouldn't be used
    if ($('#upload').length === 0) {
        return;
    }

    // FIXME: Might not need to do all of these separately
    $('#skin').select2({
      minimumResultsForSearch: Infinity
    });

    $('#scheme').select2({
      minimumResultsForSearch: Infinity
    });

    $('#language').select2({
      minimumResultsForSearch: Infinity
    });

    $('#skin').on('change', function() {
        $('body').removeClass();
        $("body").addClass('skin-' + $(this).find(':selected').val());
    });

    $('#two-factor-auth').on('change', function () {

        var container = $('.auth-code');

        if ($(this).is(':checked')) {
            container.removeClass('hide');
        } else {
            container.addClass('hide');
        }
    });

    $('#request-change-email').on('click', function() {
        var box = $(this).parents('.box');
        box.children('.overlay').removeClass('hide');
        $.post('/profile/email', function(res) {
            if (res == 'success') {
                box.children('.overlay').addClass('hide');
                box.find('.help-block').removeClass('hide');
            }
        });
    });

    var cropperData = {};
    $('.avatar>img').cropper({
        aspectRatio: 1 / 1,
        preview: '.avatar-preview',
        crop: function(data) {
            cropperData.dataX = Math.round(data.x);
            cropperData.dataY = Math.round(data.y);
            cropperData.dataHeight = Math.round(data.height);
            cropperData.dataWidth = Math.round(data.width);
            cropperData.dataRotate = Math.round(data.rotate);
        },
        built: function() {
            $('#upload-overlay').addClass('hide');
        }
    });

    var uploader = new Uploader({
        trigger: '#upload',
        name: 'file',
        action: '/profile/upload',
        accept: 'image/*',
        data: {
            '_token': $('meta[name="token"]').attr('content')
        },
        multiple: false,
        change: function(){
            $('#upload-overlay').removeClass('hide');
            this.submit();
        },
        error: function(file) {
            if (file.responseJSON.file) {
                alert(file.responseJSON.file.join(''));
            } else if (file.responseJSON.error) {
                alert(file.responseJSON.error.message);
            }

            $('#upload-overlay').addClass('hide');
        },
        success: function(response) {
            if( response.message === 'success') {
                $('.avatar>img').cropper('replace', response.image);
                cropperData.path = response.path;

                $('.current-avatar-preview').addClass('hide');
                $('.avatar-preview').removeClass('hide');
                $('#save-avatar').removeClass('hide');
            }
        }
    });

    $('#save-avatar').on('click', function(){
        $('#upload-overlay').removeClass('hide');
        $('.avatar-message .alert').addClass('hide');
        $.post('/profile/avatar', cropperData).success(function(resp) {
            $('#upload-overlay').addClass('hide');
            if (resp.image) {
                $('.avatar-message .alert.alert-success').removeClass('hide');
                $('#use-gravatar').removeClass('hide');
            } else {
                $('.avatar-message .alert.alert-danger').removeClass('hide');
            }
        });
    });

    $('#use-gravatar').on('click', function () {

        $('#upload-overlay').removeClass('hide');
        $('.avatar-message .alert').addClass('hide');

        $.post('/profile/gravatar').success(function(resp) {

            $('#upload-overlay').addClass('hide');

            // if (resp.image) {
                $('.avatar-message .alert.alert-success').removeClass('hide');
                $('.avatar-preview').addClass('hide');
                $('.current-avatar-preview').removeClass('hide');
                $('.current-avatar-preview').attr('src', resp.image);
                $('#use-gravatar').addClass('hide');
                $('#avatar-save-buttons button').addClass('hide');
            // } else {
            //     $('.avatar-preview').addClass('hide');
            //     $('#use-gravatar').removeClass('hide');
            // }
        });
    });
})(jQuery);

//# sourceMappingURL=app.js.map
